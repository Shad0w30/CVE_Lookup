<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVE Pro Lookup - Client Side</title>
    <link href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .severity-pill { transition: all 0.2s; }
        .severity-pill:hover { transform: scale(1.05); }
        .sort-icon { font-size: 0.7rem; margin-left: 4px; color: #cbd5e0; }
        .active-sort { color: #4a5568 !important; }
        tr.kev-row { border-left: 4px solid #dc2626; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen pb-20">
    <div class="container mx-auto p-4 max-w-6xl">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-extrabold text-gray-800"><i class="fas fa-shield-virus text-blue-600 mr-3"></i>CVE Lookup <span class="text-sm font-normal text-gray-500">v2.0</span></h1>
            <div class="space-x-2">
                <button id="exportJson" class="hidden text-sm bg-purple-500 text-white px-3 py-1 rounded hover:bg-purple-600 transition">
                    <i class="fas fa-code mr-1"></i> JSON
                </button>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-6">
            <div class="mb-4">
                <label for="cveInput" class="block text-sm font-semibold text-gray-700 mb-2">Target CVE IDs:</label>
                <textarea id="cveInput" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" placeholder="CVE-2021-44228, CVE-2023-23397..."></textarea>
            </div>
            
            <div class="flex flex-wrap gap-3">
                <button id="searchButton" class="flex-1 min-w-[150px] bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition shadow-lg">
                    <i class="fas fa-search mr-2"></i>Analyze CVEs
                </button>
                <button id="downloadButton" class="hidden flex-1 min-w-[150px] bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition shadow-lg">
                    <i class="fas fa-file-excel mr-2"></i>Excel Report
                </button>
                <button id="clearButton" class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-300 transition">
                    <i class="fas fa-undo"></i>
                </button>
            </div>

            <div id="loading" class="hidden mt-4 p-4 bg-blue-50 text-blue-700 rounded-lg flex items-center justify-center">
                <i class="fas fa-circle-notch fa-spin mr-3"></i>
                <span id="loadingText">Processing vulnerabilities... (0/0)</span>
            </div>
        </div>

        <div id="summaryStats" class="hidden grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg shadow-sm border-b-4 border-red-700">
                <p class="text-xs text-gray-500 uppercase font-bold">Critical</p>
                <p id="stat-critical" class="text-2xl font-black text-gray-800">0</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border-b-4 border-red-500">
                <p class="text-xs text-gray-500 uppercase font-bold">High</p>
                <p id="stat-high" class="text-2xl font-black text-gray-800">0</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border-b-4 border-yellow-500">
                <p class="text-xs text-gray-500 uppercase font-bold">Medium</p>
                <p id="stat-medium" class="text-2xl font-black text-gray-800">0</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border-b-4 border-blue-500">
                <p class="text-xs text-gray-500 uppercase font-bold">EPSS > 10%</p>
                <p id="stat-epss" class="text-2xl font-black text-gray-800">0</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border-b-4 border-black bg-red-50">
                <p class="text-xs text-red-600 uppercase font-bold"><i class="fas fa-biohazard mr-1"></i>CISA KEV</p>
                <p id="stat-kev" class="text-2xl font-black text-red-700">0</p>
            </div>
        </div>

        <div id="filterContainer" class="hidden mb-4">
            <div class="relative">
                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                    <i class="fas fa-filter"></i>
                </span>
                <input type="text" id="tableFilter" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-blue-500 sm:text-sm" placeholder="Filter results by ID or Package...">
            </div>
        </div>

        <div id="tableContainer" class="hidden bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-100">
                    <tr>
                        <th onclick="sortResults('cveId')" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-200">
                            CVE ID <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                            Package
                        </th>
                        <th onclick="sortResults('epssRaw')" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-200">
                            EPSS <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th onclick="sortResults('cvssScore')" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-200">
                            CVSS <i class="fas fa-sort sort-icon"></i>
                        </th>
                    </tr>
                </thead>
                <tbody id="resultsTable" class="bg-white divide-y divide-gray-200"></tbody>
            </table>
        </div>
        <div id="error" class="hidden mt-4 p-4 text-center text-red-600 bg-red-50 rounded-lg border border-red-200"></div>
    </div>

    <script>
        // Global State
        let cveResults = [];
        let currentSort = { key: null, direction: 'asc' };

        const searchButton = document.getElementById('searchButton');
        const downloadButton = document.getElementById('downloadButton');
        const clearButton = document.getElementById('clearButton');
        const exportJson = document.getElementById('exportJson');
        const cveInput = document.getElementById('cveInput');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loadingText');
        const errorDiv = document.getElementById('error');
        const resultsTable = document.getElementById('resultsTable');
        const tableContainer = document.getElementById('tableContainer');
        const summaryStats = document.getElementById('summaryStats');
        const tableFilter = document.getElementById('tableFilter');

        const CVE_SOURCES = {
            NVD: {
                url: cveId => `https://services.nvd.nist.gov/rest/json/cves/2.0?cveId=${cveId}`,
                parse: data => data.vulnerabilities?.[0]?.cve || null,
                directUrl: cveId => `https://nvd.nist.gov/vuln/detail/${cveId}`
            },
            EPSS: {
                url: cveId => `https://api.first.org/data/v1/epss?cve=${cveId}`,
                parse: data => data.data?.[0] || null,
                directUrl: cveId => `https://www.first.org/epss/#!/search/${cveId}`
            }
        };

        async function fetchWithRetry(url, maxRetries = 2) {
            for (let i = 0; i <= maxRetries; i++) {
                try {
                    const response = await fetch(url);
                    if (response.status === 429) {
                        await new Promise(r => setTimeout(r, 3000));
                        continue;
                    }
                    if (!response.ok) throw new Error(`Status ${response.status}`);
                    return await response.json();
                } catch (e) {
                    if (i === maxRetries) throw e;
                    await new Promise(r => setTimeout(r, 1000));
                }
            }
        }

        function updateSummary() {
            const stats = { critical: 0, high: 0, medium: 0, epss: 0, kev: 0 };
            cveResults.forEach(r => {
                if (r.severity === 'CRITICAL') stats.critical++;
                if (r.severity === 'HIGH') stats.high++;
                if (r.severity === 'MEDIUM') stats.medium++;
                if (parseFloat(r.epssRaw) > 0.1) stats.epss++;
                if (r.isKev) stats.kev++;
            });

            document.getElementById('stat-critical').textContent = stats.critical;
            document.getElementById('stat-high').textContent = stats.high;
            document.getElementById('stat-medium').textContent = stats.medium;
            document.getElementById('stat-epss').textContent = stats.epss;
            document.getElementById('stat-kev').textContent = stats.kev;
            summaryStats.classList.remove('hidden');
        }

        function sortResults(key) {
            const direction = currentSort.key === key && currentSort.direction === 'asc' ? 'desc' : 'asc';
            currentSort = { key, direction };

            cveResults.sort((a, b) => {
                let valA = a[key];
                let valB = b[key];
                
                // Handle numeric sorting
                if (!isNaN(valA) && !isNaN(valB)) {
                    valA = parseFloat(valA);
                    valB = parseFloat(valB);
                }

                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });

            renderAllRows(cveResults);
        }

        tableFilter.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = cveResults.filter(r => 
                r.cveId.toLowerCase().includes(term) || 
                r.vulnerablePackage.toLowerCase().includes(term)
            );
            renderAllRows(filtered);
        });

        function renderAllRows(data) {
            resultsTable.innerHTML = '';
            data.forEach((result, index) => renderTableRow(result, index));
        }

        function renderTableRow(result, index) {
            const row = document.createElement('tr');
            row.className = `hover:bg-blue-50 cursor-pointer transition ${result.isKev ? 'kev-row bg-red-50' : ''}`;
            row.onclick = () => toggleRowDetails(index);
            
            const severityColor = getSeverityColor(result.severity);
            const epssColor = getEPSSColor(result.epssRaw * 100);
            
            row.innerHTML = `
                <td class="px-6 py-4">
                    <div class="flex items-center">
                        <i id="icon-${index}" class="fas fa-chevron-right text-gray-300 mr-3 text-xs"></i>
                        <span class="font-bold text-gray-900">${result.cveId}</span>
                        ${result.isKev ? '<span class="ml-2 bg-red-600 text-white text-xs px-2 py-0.5 rounded-full font-black animate-pulse">KEV</span>' : ''}
                    </div>
                </td>
                <td class="px-6 py-4 text-sm font-medium text-gray-600">${result.vulnerablePackage}</td>
                <td class="px-6 py-4">
                    <span class="px-2 py-1 text-xs font-bold rounded-md ${epssColor}">${result.epssScore}</span>
                </td>
                <td class="px-6 py-4 text-sm">
                    <span class="px-2 py-1 text-xs font-bold rounded-md ${severityColor}">${result.cvssScore} ${result.severity}</span>
                </td>
            `;

            const detailsRow = document.createElement('tr');
            detailsRow.id = `details-${index}`;
            detailsRow.className = 'hidden bg-gray-50 border-l-4 border-blue-500';
            detailsRow.innerHTML = `
                <td colspan="4" class="px-10 py-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h4 class="text-xs font-bold text-blue-600 uppercase tracking-widest mb-2">Description</h4>
                            <p class="text-gray-700 leading-relaxed">${result.description}</p>
                            <div class="mt-4 flex gap-2">
                                <a href="https://nvd.nist.gov/vuln/detail/${result.cveId}" target="_blank" class="text-xs bg-white border border-gray-300 px-3 py-1 rounded shadow-sm hover:bg-gray-50">NVD Link <i class="fas fa-external-link-alt ml-1"></i></a>
                                <a href="https://www.first.org/epss/#!/search/${result.cveId}" target="_blank" class="text-xs bg-white border border-gray-300 px-3 py-1 rounded shadow-sm hover:bg-gray-50">EPSS Data <i class="fas fa-external-link-alt ml-1"></i></a>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-xs font-bold text-blue-600 uppercase tracking-widest mb-2">Metadata</h4>
                            <ul class="text-sm space-y-2">
                                <li><span class="text-gray-500">Published:</span> ${result.publishedDate}</li>
                                <li><span class="text-gray-500">CISA KEV:</span> ${result.isKev ? '<span class="text-red-600 font-bold">Yes</span>' : 'No'}</li>
                                <li><span class="text-gray-500">References:</span> ${result.references.length} found</li>
                            </ul>
                        </div>
                    </div>
                </td>
            `;

            resultsTable.appendChild(row);
            resultsTable.appendChild(detailsRow);
        }

        async function searchCVEs() {
            const input = cveInput.value.match(/CVE-\d{4}-\d{4,7}/gi);
            if (!input) {
                errorDiv.textContent = "Please enter valid CVE IDs (e.g. CVE-2021-44228)";
                errorDiv.classList.remove('hidden');
                return;
            }

            const cveList = [...new Set(input.map(c => c.toUpperCase()))];
            cveResults = [];
            loading.classList.remove('hidden');
            errorDiv.classList.add('hidden');
            resultsTable.innerHTML = '';
            
            for (let i = 0; i < cveList.length; i++) {
                const cveId = cveList[i];
                loadingText.textContent = `Analyzing ${cveId} (${i + 1}/${cveList.length})...`;
                
                try {
                    const [nvdData, epssData] = await Promise.all([
                        fetchWithRetry(CVE_SOURCES.NVD.url(cveId)),
                        fetchWithRetry(CVE_SOURCES.EPSS.url(cveId))
                    ]);

                    const cve = nvdData.vulnerabilities?.[0]?.cve;
                    const metrics = cve?.metrics?.cvssMetricV31?.[0]?.cvssData || cve?.metrics?.cvssMetricV30?.[0]?.cvssData;
                    
                    const result = {
                        cveId,
                        cvssScore: metrics?.baseScore || 'N/A',
                        severity: metrics?.baseSeverity || 'UNKNOWN',
                        epssRaw: epssData?.data?.[0]?.epss || 0,
                        epssScore: epssData?.data?.[0]?.epss ? (epssData.data[0].epss * 100).toFixed(2) + '%' : 'N/A',
                        publishedDate: cve?.published ? new Date(cve.published).toLocaleDateString() : 'N/A',
                        description: cve?.descriptions?.find(d => d.lang === 'en')?.value || 'No description found.',
                        vulnerablePackage: extractPackage(cve),
                        isKev: !!cve?.cisaExploitAdd,
                        references: cve?.references?.map(r => r.url) || []
                    };

                    cveResults.push(result);
                    renderTableRow(result, cveResults.length - 1);
                    updateSummary();

                    // Rate limit protection
                    if (cveList.length > 1) await new Promise(r => setTimeout(r, 1500));

                } catch (e) {
                    console.error(e);
                }
            }

            loading.classList.add('hidden');
            tableContainer.classList.remove('hidden');
            document.getElementById('filterContainer').classList.remove('hidden');
            downloadButton.classList.remove('hidden');
            exportJson.classList.remove('hidden');
        }

        function extractPackage(cve) {
            try {
                const nodes = cve?.configurations?.[0]?.nodes;
                if (nodes) {
                    for (const node of nodes) {
                        const cpe = node.cpeMatch?.[0]?.criteria;
                        if (cpe) return cpe.split(':')[4] || 'General';
                    }
                }
            } catch (e) {}
            return 'Multiple/Unknown';
        }

        function getSeverityColor(s) {
            if (s === 'CRITICAL') return 'bg-red-700 text-white';
            if (s === 'HIGH') return 'bg-red-100 text-red-800';
            if (s === 'MEDIUM') return 'bg-yellow-100 text-yellow-800';
            return 'bg-gray-100 text-gray-800';
        }

        function getEPSSColor(score) {
            if (score > 10) return 'bg-orange-600 text-white';
            if (score > 1) return 'bg-orange-100 text-orange-800';
            return 'bg-green-100 text-green-800';
        }

        function toggleRowDetails(index) {
            const el = document.getElementById(`details-${index}`);
            const icon = document.getElementById(`icon-${index}`);
            const isHidden = el.classList.contains('hidden');
            el.classList.toggle('hidden');
            icon.className = isHidden ? 'fas fa-chevron-down text-blue-500 mr-3 text-xs' : 'fas fa-chevron-right text-gray-300 mr-3 text-xs';
        }

        function downloadExcel() {
            const ws = XLSX.utils.json_to_sheet(cveResults);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "CVE Analysis");
            XLSX.writeFile(wb, `CVE_Report_${new Date().getTime()}.xlsx`);
        }

        exportJson.onclick = () => {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(cveResults, null, 2));
            const dlAnchorElem = document.createElement('a');
            dlAnchorElem.setAttribute("href", dataStr);
            dlAnchorElem.setAttribute("download", "cve_data.json");
            dlAnchorElem.click();
        };

        searchButton.onclick = searchCVEs;
        downloadButton.onclick = downloadExcel;
        clearButton.onclick = () => location.reload();
    </script>
</body>
</html>
