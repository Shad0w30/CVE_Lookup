<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVE & SBOM Intel v5.0</title>
    <link href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; }
        
        /* Research Links - Purple Theme */
        .research-card {
            transition: all 0.2s ease;
            border: 1px solid #f3e8ff;
            background: #faf5ff;
            color: #7e22ce;
        }
        .research-card:hover {
            border-color: #a855f7;
            background: #f3e8ff;
        }
        
        /* Severity Pastels */
        .theme-critical { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .theme-high { background-color: #ffedd5; color: #9a3412; border: 1px solid #fed7aa; }
        .theme-medium { background-color: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        .theme-total { background-color: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }

        /* Component Inventory Styling */
        .component-tag { background: #f1f5f9; border: 1px solid #e2e8f0; color: #64748b; }
        
        .progress-bar { height: 6px; background: #e2e8f0; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #3b82f6, #8b5cf6); transition: width 0.3s; }
        
        .upload-zone { border: 2px dashed #cbd5e1; border-radius: 1.5rem; transition: all 0.2s; cursor: pointer; }
        .upload-zone:hover { border-color: #3b82f6; background: #f0f7ff; }
    </style>
</head>
<body class="p-4 md:p-10">
    <div class="max-w-6xl mx-auto">
        
        <div class="flex items-center mb-8">
            <div class="p-3 bg-indigo-600 rounded-2xl shadow-lg mr-4 text-white">
                <i class="fas fa-layer-group text-2xl"></i>
            </div>
            <div>
                <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight">Vulnerability Intelligence</h1>
                <p class="text-sm text-slate-400 font-medium">CVE Lookup & SBOM Inventory v5.0</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="lg:col-span-2 bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 block">Manual CVE Scan</label>
                <textarea id="cveInput" rows="4" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none font-mono text-sm" placeholder="Enter CVE IDs (e.g., CVE-2023-23397)"></textarea>
            </div>
            <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100 flex flex-col">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 block">SBOM Integration</label>
                <div id="dropZone" class="upload-zone flex-grow flex flex-col items-center justify-center p-4 text-center">
                    <i class="fas fa-file-import text-slate-300 text-2xl mb-2"></i>
                    <p id="fileStatus" class="text-xs font-bold text-slate-500 leading-tight">Drop SBOM JSON<br><span class="font-normal opacity-60">(CycloneDX/SPDX)</span></p>
                    <input type="file" id="fileInput" class="hidden" accept=".json">
                </div>
            </div>
        </div>

        <div class="flex flex-col md:flex-row gap-4 mb-8 items-center">
            <button id="runScan" class="w-full md:w-auto px-8 py-4 bg-blue-600 text-white rounded-2xl font-bold shadow-lg shadow-blue-100 hover:bg-blue-700 transition flex items-center justify-center">
                <i class="fas fa-bolt-lightning mr-2"></i> Initiate Analysis
            </button>
            <div id="loader" class="hidden flex-grow px-4">
                <div class="flex justify-between text-[10px] font-black text-slate-400 uppercase mb-1">
                    <span id="loadText">Processing...</span>
                    <span id="loadCount">0 / 0</span>
                </div>
                <div class="progress-bar"><div id="progressFill" class="progress-fill" style="width: 0%"></div></div>
            </div>
        </div>

        <div id="statsGrid" class="hidden grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-8">
            <div class="theme-total p-4 rounded-2xl text-center"><p class="text-[10px] font-black uppercase mb-1 opacity-60">Total CVEs</p><p id="count-total" class="text-2xl font-black">0</p></div>
            <div class="theme-critical p-4 rounded-2xl text-center"><p class="text-[10px] font-black uppercase mb-1 opacity-80">Critical</p><p id="count-crit" class="text-2xl font-black">0</p></div>
            <div class="theme-high p-4 rounded-2xl text-center"><p class="text-[10px] font-black uppercase mb-1 opacity-80">High</p><p id="count-high" class="text-2xl font-black">0</p></div>
            <div class="theme-medium p-4 rounded-2xl text-center"><p class="text-[10px] font-black uppercase mb-1 opacity-80">Medium</p><p id="count-med" class="text-2xl font-black">0</p></div>
            <div class="bg-blue-50 text-blue-700 border border-blue-100 p-4 rounded-2xl text-center"><p class="text-[10px] font-black uppercase mb-1 opacity-70">SBOM Items</p><p id="count-sbom" class="text-2xl font-black">0</p></div>
            <div class="bg-purple-50 text-purple-700 border border-purple-100 p-4 rounded-2xl text-center"><p class="text-[10px] font-black uppercase mb-1 opacity-70">CISA KEV</p><p id="count-kev" class="text-2xl font-black">0</p></div>
        </div>

        <div id="sbomInventory" class="hidden mb-8">
            <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 ml-2">Software Bill of Materials (SBOM) Inventory</h3>
            <div class="bg-white rounded-3xl border border-slate-100 p-6 shadow-sm max-h-64 overflow-y-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3" id="inventoryList">
                </div>
        </div>

        <div id="resultsView" class="hidden bg-white rounded-[2rem] border border-slate-100 shadow-sm overflow-hidden">
            <table class="min-w-full">
                <thead class="bg-slate-50/50 border-b border-slate-100">
                    <tr class="text-[10px] font-black text-slate-400 uppercase tracking-widest">
                        <th class="px-8 py-5 text-left">Security ID</th>
                        <th class="px-8 py-5 text-left">Source / Component</th>
                        <th class="px-8 py-5 text-center">Severity</th>
                    </tr>
                </thead>
                <tbody id="vulnTable" class="divide-y divide-slate-50"></tbody>
            </table>
        </div>
    </div>

    <script>
        const CVE_REGEX = /\bCVE-\d{4}-\d{4,7}\b/gi;
        let findings = [];
        let components = [];

        // UI Selectors
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const vulnTable = document.getElementById('vulnTable');
        const inventoryList = document.getElementById('inventoryList');

        // SBOM File Logic
        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('fileStatus').innerHTML = `<span class="text-blue-600">${file.name}</span><br><span class="text-[10px] opacity-60">Ready to scan</span>`;
            
            try {
                const data = JSON.parse(await file.text());
                components = (data.components || data.packages || []).map(c => ({
                    name: c.name || "Unknown",
                    version: c.version || "N/A",
                    purl: c.purl || ""
                }));
            } catch (err) { alert("Invalid JSON SBOM."); }
        };

        async function apiFetch(url) {
            // NVD Rate Limiting Buffer
            await new Promise(r => setTimeout(r, 650));
            try {
                const r = await fetch(url);
                if (r.status === 403) return { error: "Rate Limited" };
                return await r.json();
            } catch (e) { return { error: "Network Error" }; }
        }

        async function runAnalysis() {
            const rawCves = document.getElementById('cveInput').value.match(CVE_REGEX) || [];
            const uniqueCves = [...new Set(rawCves.map(c => c.toUpperCase()))];
            
            findings = [];
            document.getElementById('loader').classList.remove('hidden');
            const totalTasks = uniqueCves.length + components.length;
            
            // 1. Process Manual CVEs (With Validation)
            for(let i=0; i < uniqueCves.length; i++) {
                const cveId = uniqueCves[i];
                updateLoader(`Validating ${cveId}`, i + 1, totalTasks);
                await processCve(cveId, "Manual Input");
            }

            // 2. Process SBOM Components
            for(let i=0; i < components.length; i++) {
                const comp = components[i];
                updateLoader(`Checking ${comp.name}`, uniqueCves.length + i + 1, totalTasks);
                // In a browser tool, we search by keyword to approximate matches
                const search = await apiFetch(`https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=${comp.name} ${comp.version}`);
                if(search.vulnerabilities) {
                    for(let v of search.vulnerabilities.slice(0, 2)) {
                        await processCve(v.cve.id, comp.name);
                    }
                }
            }

            finalizeUI();
        }

        async function processCve(id, source) {
            // Check if already found
            if(findings.some(f => f.id === id)) return;

            const [nvd, epss] = await Promise.all([
                apiFetch(`https://services.nvd.nist.gov/rest/json/cves/2.0?cveId=${id}`),
                apiFetch(`https://api.first.org/data/v1/epss?cve=${id}`)
            ]);

            if(nvd.vulnerabilities?.length > 0) {
                const c = nvd.vulnerabilities[0].cve;
                const m = c.metrics?.cvssMetricV31?.[0]?.cvssData || c.metrics?.cvssMetricV30?.[0]?.cvssData;
                findings.push({
                    id, source,
                    score: m?.baseScore || "N/A",
                    severity: m?.baseSeverity || "UNKNOWN",
                    desc: c.descriptions.find(d => d.lang === 'en')?.value || "No description.",
                    isKev: !!c.cisaExploitAdd,
                    refs: c.references?.map(r => r.url) || []
                });
                renderTable();
                updateStats();
            }
        }

        function updateLoader(text, count, total) {
            document.getElementById('loadText').innerText = text;
            document.getElementById('loadCount').innerText = `${count} / ${total}`;
            document.getElementById('progressFill').style.width = `${(count/total)*100}%`;
        }

        function renderTable() {
            vulnTable.innerHTML = findings.map((f, idx) => `
                <tr class="hover:bg-slate-50/50 transition cursor-pointer" onclick="toggleRow(${idx})">
                    <td class="px-8 py-5">
                        <span class="font-bold text-slate-800">${f.id}</span>
                        ${f.isKev ? '<span class="ml-2 text-[8px] font-black bg-purple-600 text-white px-2 py-0.5 rounded-full uppercase">KEV</span>' : ''}
                    </td>
                    <td class="px-8 py-5 text-[10px] font-bold text-slate-400 uppercase truncate max-w-[200px]">${f.source}</td>
                    <td class="px-8 py-5 text-center">
                        <span class="px-3 py-1 rounded-full text-[10px] font-black inline-block min-w-[90px] ${getSevTheme(f.severity)}">
                            ${f.score} ${f.severity}
                        </span>
                    </td>
                </tr>
                <tr id="row-${idx}" class="hidden bg-slate-50/30">
                    <td colspan="3" class="px-10 py-6">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div class="lg:col-span-2">
                                <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Description</h4>
                                <p class="text-sm text-slate-600 leading-relaxed">${f.desc}</p>
                            </div>
                            <div>
                                <h4 class="text-[10px] font-black text-purple-800 uppercase tracking-widest mb-3">Threat Research</h4>
                                <div class="grid grid-cols-2 gap-2">
                                    <a href="https://nvd.nist.gov/vuln/detail/${f.id}" target="_blank" class="research-card p-2 rounded-lg text-[9px] font-bold text-center">NVD</a>
                                    <a href="https://www.wiz.io/vulnerability-database/cve/${f.id.toLowerCase()}" target="_blank" class="research-card p-2 rounded-lg text-[9px] font-bold text-center">Wiz Intel</a>
                                    <a href="https://snyk.io/vuln/${f.id}" target="_blank" class="research-card p-2 rounded-lg text-[9px] font-bold text-center">Snyk</a>
                                    <a href="https://github.com/advisories?query=${f.id}" target="_blank" class="research-card p-2 rounded-lg text-[9px] font-bold text-center">GitHub</a>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function finalizeUI() {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('statsGrid').classList.remove('hidden');
            document.getElementById('resultsView').classList.remove('hidden');
            
            // Render Component Inventory
            if(components.length > 0) {
                document.getElementById('sbomInventory').classList.remove('hidden');
                inventoryList.innerHTML = components.map(c => `
                    <div class="flex items-center justify-between p-3 component-tag rounded-xl">
                        <div class="truncate mr-2">
                            <p class="text-[11px] font-bold text-slate-700 truncate">${c.name}</p>
                            <p class="text-[9px] text-slate-400">v${c.version}</p>
                        </div>
                        <i class="fas fa-check-circle text-blue-400 text-xs"></i>
                    </div>
                `).join('');
            }
        }

        function updateStats() {
            const s = { total: findings.length, crit: 0, high: 0, med: 0, kev: 0 };
            findings.forEach(f => {
                if(f.severity === 'CRITICAL') s.crit++;
                if(f.severity === 'HIGH') s.high++;
                if(f.severity === 'MEDIUM') s.med++;
                if(f.isKev) s.kev++;
            });
            document.getElementById('count-total').innerText = s.total;
            document.getElementById('count-crit').innerText = s.crit;
            document.getElementById('count-high').innerText = s.high;
            document.getElementById('count-med').innerText = s.med;
            document.getElementById('count-sbom').innerText = components.length;
            document.getElementById('count-kev').innerText = s.kev;
        }

        function getSevTheme(s) {
            if (s === 'CRITICAL') return 'theme-critical';
            if (s === 'HIGH') return 'theme-high';
            if (s === 'MEDIUM') return 'theme-medium';
            return 'bg-slate-100 text-slate-400';
        }

        function toggleRow(i) { document.getElementById(`row-${i}`).classList.toggle('hidden'); }
        document.getElementById('runScan').onclick = runAnalysis;
    </script>
</body>
</html>
